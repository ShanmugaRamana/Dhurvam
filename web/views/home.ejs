<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhurvam AI - Honeypot</title>
    <link rel="stylesheet" href="/css/home.css">
</head>

<body>
    <div class="app-layout">
        <!-- Left: Session Panel -->
        <div class="session-panel" id="sessionPanel">
            <div class="panel-header">
                <h3>Sessions</h3>
                <button id="collapseBtn" class="collapse-btn">◀</button>
            </div>

            <button id="newSessionBtn" class="new-session-btn">+ New Session</button>

            <div class="session-list">
                <h4>Active</h4>
                <div id="activeSessionsList"></div>

                <h4>Ended</h4>
                <div id="endedSessionsList"></div>
            </div>
        </div>

        <!-- Center: Main Chat Area -->
        <div class="main-panel">
            <div class="brand-header">
                <span class="brand-title">Dhurvam AI</span>
                <button id="logoutBtn">Logout</button>
            </div>

            <div class="session-header" id="sessionHeader">
                <span id="currentSessionInfo">Select or create a session</span>
            </div>

            <div class="conversation-display" id="conversationDisplay"></div>

            <div class="chat-container">
                <select id="channelSelect">
                    <option value="SMS">SMS</option>
                    <option value="Email">Email</option>
                    <option value="WhatsApp">WhatsApp</option>
                </select>
                <input type="text" id="chatInput" placeholder="Type a scam message to test...">
                <button id="sendBtn">Send</button>
            </div>
        </div>

        <!-- Right: Logs Panel -->
        <div class="logs-panel">
            <div class="log-section backend-log">
                <h2>Backend Log</h2>
                <div id="backendLogContent" class="log-content"></div>
            </div>
            <div class="log-section frontend-log">
                <h2>Frontend Log</h2>
                <div id="frontendLogContent" class="log-content"></div>
            </div>
        </div>
    </div>

    <!-- Scam Report Modal -->
    <div id="scamReportModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal()">&times;</span>
            <h2>Scam Intelligence Report</h2>
            <p><strong>Session ID:</strong> <span id="modalSessionId"></span></p>
            <p><strong>Status:</strong> <span id="modalStatus"></span></p>
            <p><strong>Messages Exchanged:</strong> <span id="modalMessages"></span></p>
            <p><strong>End Reason:</strong> <span id="modalEndReason"></span></p>

            <h3>Extracted Intelligence:</h3>
            <ul id="modalIntelligence"></ul>

            <h3>Conversation History:</h3>
            <div id="modalConversation" class="modal-conversation"></div>

            <h3>Agent Notes:</h3>
            <p id="modalNotes"></p>

            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        // Global state
        let sessions = [];
        let activeSessionId = null;
        let sessionTimeouts = {};  // Track timeouts per session

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
            setInterval(loadSessions, 3000);  // Refresh every 3s
            setInterval(pollBackendLogs, 2000);
        });

        // Generate session ID
        function generateSessionId() {
            return 'sess-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
        }

        // Add frontend log
        function addFrontendLog(message, type = 'INFO') {
            const logDiv = document.getElementById('frontendLogContent');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="log-entry log-${type.toLowerCase()}">[${timestamp}] [${type}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Load sessions from API
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                sessions = data.sessions || [];
                renderSessionLists();
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        // Render session lists
        function renderSessionLists() {
            const activeList = document.getElementById('activeSessionsList');
            const endedList = document.getElementById('endedSessionsList');

            const activeSessions = sessions.filter(s => s.status === 'active');
            const endedSessions = sessions.filter(s => s.status === 'ended');

            activeList.innerHTML = activeSessions.map(s => `
                <div class="session-card ${s.sessionId === activeSessionId ? 'selected' : ''}" 
                     onclick="switchSession('${s.sessionId}')">
                    <div class="session-row">
                        <span class="session-id">${s.sessionId.substring(0, 12)}...</span>
                        <span class="session-badge active">Active</span>
                    </div>
                    <div class="session-row">
                        <span>${s.channel}</span>
                        <span>${s.totalMessages} msgs</span>
                    </div>
                </div>
            `).join('') || '<p class="no-sessions">No active sessions</p>';

            endedList.innerHTML = endedSessions.slice(0, 10).map(s => `
                <div class="session-card ended">
                    <div class="session-row">
                        <span class="session-id">${s.sessionId.substring(0, 12)}...</span>
                        <span class="session-badge ended">Ended</span>
                    </div>
                    <div class="session-row">
                        <span>${s.channel}</span>
                        <span>${s.totalMessages} msgs</span>
                    </div>
                    <button class="view-output-btn" onclick="viewOutput('${s.sessionId}')">View Output</button>
                </div>
            `).join('') || '<p class="no-sessions">No ended sessions</p>';
        }

        // Switch to a session
        async function switchSession(sessionId) {
            activeSessionId = sessionId;

            // Get session details
            try {
                const response = await fetch(`/api/session/${sessionId}/output`);
                const data = await response.json();

                // Display conversation
                const convDiv = document.getElementById('conversationDisplay');
                convDiv.innerHTML = (data.conversationHistory || []).map(msg => {
                    const senderClass = msg.sender === 'scammer' ? 'msg-scammer' : 'msg-agent';
                    const displaySender = msg.sender === 'scammer' ? 'scammer' : 'user';
                    return `<div class="msg ${senderClass}"><strong>${displaySender}:</strong> ${msg.text}</div>`;
                }).join('');
                convDiv.scrollTop = convDiv.scrollHeight;

                // Update header
                document.getElementById('currentSessionInfo').textContent =
                    `Session: ${sessionId.substring(0, 15)}... | ${data.metadata?.channel || 'Unknown'} | ${data.totalMessagesExchanged} msgs`;

                addFrontendLog(`Switched to session: ${sessionId.substring(0, 15)}...`);

            } catch (error) {
                addFrontendLog(`Failed to load session: ${error.message}`, 'ERROR');
            }

            renderSessionLists();
        }

        // Create new session
        document.getElementById('newSessionBtn').addEventListener('click', () => {
            activeSessionId = null;
            document.getElementById('conversationDisplay').innerHTML = '';
            document.getElementById('currentSessionInfo').textContent = 'New session - send a message to start';
            addFrontendLog('New session started');
            renderSessionLists();
        });

        // View session output
        async function viewOutput(sessionId) {
            try {
                const response = await fetch(`/api/session/${sessionId}/output`);
                const data = await response.json();
                showScamReport(data);
            } catch (error) {
                addFrontendLog(`Failed to get output: ${error.message}`, 'ERROR');
            }
        }

        // Collapse panel
        document.getElementById('collapseBtn').addEventListener('click', () => {
            const panel = document.getElementById('sessionPanel');
            const btn = document.getElementById('collapseBtn');
            panel.classList.toggle('collapsed');
            btn.textContent = panel.classList.contains('collapsed') ? '▶' : '◀';
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            window.location.replace('/');
        });

        // Reset timeout for session
        function resetSessionTimeout(sessionId) {
            // Clear existing timeout
            if (sessionTimeouts[sessionId]) {
                clearTimeout(sessionTimeouts[sessionId]);
            }

            // Set new 45-second timeout
            sessionTimeouts[sessionId] = setTimeout(async () => {
                addFrontendLog(`Session ${sessionId.substring(0, 12)}... timed out (45s)`, 'WARNING');

                try {
                    const response = await fetch(`/api/session/${sessionId}/timeout`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.status === 'ended') {
                        showScamReport(data);
                        if (activeSessionId === sessionId) {
                            activeSessionId = null;
                        }
                        // Clean up the timeout ID after execution
                        delete sessionTimeouts[sessionId];
                        loadSessions();
                    }
                } catch (error) {
                    addFrontendLog(`Timeout error: ${error.message}`, 'ERROR');
                }
            }, 45000);
        }

        // Send message
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const input = document.getElementById('chatInput');
            const channel = document.getElementById('channelSelect').value;
            const text = input.value.trim();

            if (!text) return;

            // Use active session or create new one
            let sessionId = activeSessionId || generateSessionId();

            // IMPORTANT: Clear existing timeout when scammer sends new message
            if (sessionTimeouts[sessionId]) {
                clearTimeout(sessionTimeouts[sessionId]);
                addFrontendLog(`Timeout cleared - scammer responded`, 'INFO');
            }

            const payload = {
                sessionId: sessionId,
                message: {
                    sender: "scammer",
                    text: text,
                    timestamp: Date.now()
                },
                conversationHistory: [],
                metadata: {
                    channel: channel,
                    language: "English",
                    locale: "IN"
                }
            };

            addFrontendLog(`Sending: "${text.substring(0, 30)}..." via ${channel}`);

            // Add to conversation display
            const convDiv = document.getElementById('conversationDisplay');
            convDiv.innerHTML += `<div class="msg msg-scammer"><strong>scammer:</strong> ${text}</div>`;
            convDiv.scrollTop = convDiv.scrollHeight;

            input.value = '';

            try {
                const response = await fetch('/api/detect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.status === 'success') {

                    if (data.classification === 'Human') {
                        // Human detected → Close session, no reply displayed
                        addFrontendLog('Classified as Human. Session closed.', 'INFO');
                        activeSessionId = null;
                        document.getElementById('conversationDisplay').innerHTML = '';

                    } else if (data.classification === 'Scammer' || data.sessionActive) {
                        // Scammer detected → Show reply and keep session active
                        addFrontendLog(`Reply: ${data.reply}`, 'SUCCESS');
                        convDiv.innerHTML += `<div class="msg msg-agent"><strong>user:</strong> ${data.reply}</div>`;
                        convDiv.scrollTop = convDiv.scrollHeight;
                        addFrontendLog('Scammer detected. Session active.', 'WARNING');
                        activeSessionId = data.sessionId || sessionId;

                        // Update header
                        document.getElementById('currentSessionInfo').textContent =
                            `Session: ${activeSessionId.substring(0, 15)}... | ${channel} | Active`;

                        // Start 45s timeout after agent reply
                        resetSessionTimeout(activeSessionId);

                        loadSessions();
                    }

                } else if (data.status === 'ended') {
                    addFrontendLog('Conversation ended. Showing report.', 'SUCCESS');
                    showScamReport(data);

                    // Clear timeout and remove from tracking
                    if (sessionTimeouts[sessionId]) {
                        clearTimeout(sessionTimeouts[sessionId]);
                        delete sessionTimeouts[sessionId];
                    }

                    activeSessionId = null;
                    loadSessions();

                } else if (data.error) {
                    addFrontendLog(`Error: ${data.error}`, 'ERROR');
                }

            } catch (error) {
                addFrontendLog(`Network error: ${error.message}`, 'ERROR');
            }
        });

        // Enter key to send
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendBtn').click();
            }
        });

        // Show scam report popup
        function showScamReport(data) {
            document.getElementById('modalSessionId').textContent = data.sessionId;
            document.getElementById('modalStatus').textContent = data.status || 'ended';
            document.getElementById('modalMessages').textContent = data.totalMessagesExchanged || 0;
            document.getElementById('modalEndReason').textContent = data.endReason || 'N/A';

            const intel = data.extractedIntelligence || {};
            document.getElementById('modalIntelligence').innerHTML = `
                <li><strong>Bank Accounts:</strong> ${(intel.bankAccounts || []).join(', ') || 'None'}</li>
                <li><strong>UPI IDs:</strong> ${(intel.upiIds || []).join(', ') || 'None'}</li>
                <li><strong>Links:</strong> ${(intel.phishingLinks || []).join(', ') || 'None'}</li>
                <li><strong>Phone Numbers:</strong> ${(intel.phoneNumbers || []).join(', ') || 'None'}</li>
                <li><strong>Keywords:</strong> ${(intel.suspiciousKeywords || []).join(', ') || 'None'}</li>
            `;

            // Show conversation history
            const convHistory = data.conversationHistory || [];
            document.getElementById('modalConversation').innerHTML = convHistory.map(msg => {
                const displaySender = msg.sender === 'scammer' ? 'scammer' : 'user';
                return `<div class="modal-msg ${msg.sender === 'scammer' ? 'msg-scammer' : 'msg-agent'}">
                    <strong>${displaySender}:</strong> ${msg.text}
                </div>`;
            }).join('');

            document.getElementById('modalNotes').textContent = data.agentNotes || 'No notes available';
            document.getElementById('scamReportModal').style.display = 'flex';
        }

        // Close modal
        function closeModal() {
            document.getElementById('scamReportModal').style.display = 'none';
        }

        // Poll backend logs
        async function pollBackendLogs() {
            try {
                const response = await fetch('/api/logs');
                const data = await response.json();

                if (data.logs) {
                    const logDiv = document.getElementById('backendLogContent');
                    logDiv.innerHTML = data.logs.map(log =>
                        `<div class="log-entry">${log}</div>`
                    ).join('');
                    logDiv.scrollTop = logDiv.scrollHeight;
                }
            } catch (error) {
                console.error('Failed to fetch logs:', error);
            }
        }
    </script>
</body>

</html>